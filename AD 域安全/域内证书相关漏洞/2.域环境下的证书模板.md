# 证书模板

**证书模板**是一种用于定义证书属性和行为的预配置模板。它决定了证书在域环境下的配置。其作用如下：

- **简化证书管理**：管理员可以通过模板快速创建满足特定需求的证书。
- **提高一致性**：确保所有颁发的证书遵循统一的配置。
- **增强安全性**：通过模板限定哪些用户或设备可以申请证书，以及证书的用途。

管理员可以对证书模板执行以下操作：

1. 查看每个证书模板的属性。
2. 复制和修改证书模板。
3. 控制哪些用户和计算机可以使用此模板注册证书。
4. 其他。

### 证书模块的查看和修改

certtmpl.msc 命令可以看到系统默认的证书模板有哪些。右击模板---->属性，就可以看到模板的属性。默认微软设置了很多证书模板，用于域内各种用途。

![image-20250213100720661](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/AD%20%E5%9F%9F%E5%AE%89%E5%85%A8/%E5%9F%9F%E5%86%85%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/images/image-20250213100720661.png)

大部分模板无法修改，如果想修改某个模板，建议将这个模板复制后得到一个新模板，然后对这个新模板进行修改。

### 证书模板的属性

证书模板的属性中，主要是一些证书设置，证书模板的属性会直接影响到使用此证书模板申请到的证书的具体内容。

##### 使用者名称

其主要配置作用是，当用户以使用此模板申请证书时，服务器将使用这些配置来获取使用者名称。使用者名称属性有两个设置选项如下：

- 在请求中提供：用户申请证书时，需要提供使用者名称。
- 使用 AD 数据库中的信息生成：用户申请证书时，域控将会从 ad 域中查询使用者名称。
  - 使用者名称格式
  - 将这个信息包含在另一个使用者名称中

![image-20250213101018587](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/AD%20%E5%9F%9F%E5%AE%89%E5%85%A8/%E5%9F%9F%E5%86%85%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/images/image-20250213101018587.png)

##### 发布要求

此属性决定着证书申请成功所需要的具体条件，主要有以下三个选项组成。

![image-20250213101337386](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/AD%20%E5%9F%9F%E5%AE%89%E5%85%A8/%E5%9F%9F%E5%86%85%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/images/image-20250213101337386.png)

##### CA 证书管理程序批准

此选项对应着证书模板在AD数据库中的 msPKI-Enrollment-Flag 属性上的 CT_FLAG_PEND_ALL_REQUESTS (0x2) 位，如果选中这个选项，那么使用此模板申请的证书将不会立即签发，证书会处于一种待处理的状态，等待管理员的批准。如下图的 certsrv.msc 的 “挂起的申请”：

![image-20250213101447312](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/AD%20%E5%9F%9F%E5%AE%89%E5%85%A8/%E5%9F%9F%E5%86%85%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/images/image-20250213101447312.png)

##### 授权签名的数量

如果选择此选项并设置一个数字 n，则表示在使用此模板申请证书时，必须由 n 个独立的签名者 对证书申请进行批准后，证书才能最终签发。此设置通常用于高安全性场景，例如代码签名证书或关键系统的管理证书申请审批，以确保多方参与审核和签署。此选项不会影响证书本身的签名结构或证书链。

##### 应用程序策略

在证书模板中使用 **应用程序策略** 属性添加 EKU OID 时，申请基于该模板的证书时，生成的证书会包含相应的 EKU OID，用于限制证书在域环境下的用途。例如：

- 如果模板中配置了 EKU OID 1.3.6.1.4.1.311.20.2.1（智能卡登录），则申请到的证书中将包含该 OID，表明该证书支持智能卡登录。
- 申请证书时，CA 会验证颁发者证书是否有权限签发该用途的证书（例如是否具有 Certificate Signing 权限）。

##### 取代模板

此模板颁发的证书会取代该属性中所有添加到这个列表的模板所颁发的证书。当使用此模板注册成功后，新证书将替换下面列表中的证书，原先的证书将失效。

![image-20250213102041781](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/AD%20%E5%9F%9F%E5%AE%89%E5%85%A8/%E5%9F%9F%E5%86%85%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/images/image-20250213102041781.png)

##### 扩展

扩展限制了这个模板的用途，比如说智能卡登录、服务器身份验证、客户端身份验证等。当用户在域环境下使用此模板的证书时，域控将判断是否有当前使用场景的扩展。应用程序策略中包含如下用途的证书可用于 Kerberos 身份认证：

- 客户端身份验证，对应的 OID 为 1.3.6.1.5.5.7.3.2
- PKINIT 客户端身份验证，对应的 OID 为 1.3.6.1.5.2.3.4，默认情况下，没有该 OID，需要手动添加
- 智能卡登录，对应的 OID 为 1.3.6.1.4.1.311.20.2.2
- 任何目的，对应的 OID 为 2.5.29.37.0
- 子 CA

此外，Specterops 发现可以滥用的另一个 EKU OID 是证书申请代理，对应的 OID 为 1.3.6.1.4.1.311.20.2.1。除⾮设置了特定限制，否则具有此 OID 的证书可用于代表其他用户申请证书。

![image-20250213102203275](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/AD%20%E5%9F%9F%E5%AE%89%E5%85%A8/%E5%9F%9F%E5%86%85%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/images/image-20250213102203275.png)

##### 安全

证书模板也属于安全对象，表明对域用户设置的 acl 权限。

##### 常规

证书的有效期和续订期。

##### 兼容性

模板兼容的证书颁发机构和证书接收人。

##### 请求处理

了证书的目的，以及该证书能否允许导出私钥等。

##### 加密

加密服务提供程序(CSP)和最小密钥大小。
