### 缓存欺骗

**核心原理**：利用缓存与服务器对请求解析的差异，使缓存误存动态敏感响应，攻击者通过命中缓存键获取用户敏感信息。

这里面很重要的一点，就是缓存和服务器之间的解析差异。我们对比一下缓存欺骗和缓存中毒：

- **与缓存中毒对比**：
  - **缓存中毒**：攻击者主动注入恶意响应到缓存，供其他用户访问。
  - **缓存欺骗**：诱使用户自行缓存敏感信息，攻击者再读取该缓存。

### 构建缓存欺骗攻击

1. **定位目标端点**
   - 找到返回敏感信息的**动态响应端点**（如用户个人数据接口）。
   - 优先关注支持 **GET/HEAD/OPTIONS** 方法的端点（这类请求易被缓存）。
2. **发现解析差异**
   - 分析缓存与服务器对 **URL 路径解析** 的差异（如路径映射、分隔符处理、路径规范化等）。
   - 目标：让服务器将请求解析为**敏感信息请求**，但缓存将其视为**静态资源请求**。
3. **构造恶意 URL**
   - 利用解析差异生成特殊 URL，诱骗用户访问后，缓存存储包含其敏感信息的响应。
   - **攻击验证**：通过 Burp 发送请求，获取缓存中的敏感数据（避免直接用浏览器访问导致会话失效）。

### 路径映射差异与缓存欺骗

**URL 路径映射类型**：

1. **传统映射**：URL 路径直接对应服务器文件系统路径（如`http://example.com/path/file.html`指向物理文件）。
2. **RESTful 映射**：URL 路径抽象为逻辑端点和参数（如`http://example.com/api/user/123`通过参数识别资源）。

**漏洞成因**：
缓存与服务器对同一 URL 路径的解析逻辑不同，导致缓存误存敏感数据。

**示例解析**：

- URL：`http://example.com/user/123/profile/wcd.css`
  - **服务器（RESTful）**：将路径视为 `/user/123/profile` 端点，`wcd.css` 为无关参数，返回用户敏感资料（如个人信息）。
  - **缓存（传统）**：将路径视为 `/user/123/profile/wcd.css`，匹配 `.css` 静态资源缓存规则，存储服务器返回的敏感数据并标记为 CSS 文件。

当用户多次访问 `http://example.com/user/123/profile/wcd.css` 时，会将自己的敏感信息投入缓存中，缓存键为： `/user/123/profile/wcd.css`。攻击者通过访问此路径命中缓存键，获取用户信息。

### 利用路径映射差异

##### 1. 测试服务器路径解析逻辑

- 方法：在目标 URL 后添加任意路径段（如 /foo 或 /bar 等），观察响应是否包含相同敏感数据。
- 示例
  - 原始 URL：`/api/orders/123`（返回订单信息）
  - 修改后：`/api/orders/123/foo`
  - **结果**：若响应仍为订单信息，说明服务器**抽象路径逻辑**，忽略新增路径段。

##### 2. 测试缓存路径解析逻辑

- 方法：在 URL 中添加静态扩展名（如：.js 或 .css 等），验证响应是否被缓存。
- 示例
  - 修改后 URL：`/api/orders/123/foo.js`
  - 结果：
    - 若响应被缓存，说明缓存按**完整路径 + 扩展名**解析，且存在对应缓存规则（如存储 `.js` 结尾的请求）。
    - 可尝试更多扩展名（`.css` `.ico` `.exe` 等）扩大测试范围。

##### 3. 构造攻击 URL

- 逻辑：利用服务器 “忽略路径段”+ 缓存 “匹配扩展名” 的差异，使动态敏感响应存入静态缓存键。
  - 示例：
    - 服务器对 `/my-account/abc.js` 的解析等同于 `/my-account/`，返回用户账户敏感信息；
    - 缓存将 `/my-account/abc.js` 视为静态资源（`.js`），按规则存储响应。
  - **结果**：攻击者访问该 URL 时，缓存直接返回已存储的用户敏感数据。

![image-20250507152456298](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/Web%20%E5%AE%89%E5%85%A8/Web%20%E7%BC%93%E5%AD%98%E6%AC%BA%E9%AA%97/images/image-20250507152456298.png)

而且，注意 X-Cache: hit，说明缓存已经命中，缓存可能记录的缓存键为：/my-account/abc.js

利用：

```
# 让受害者 carlos 多次访问 /my-account/wcd.js，使得路径抽象为 /my-account，且让缓存服务器存储响应。
<script>document.location="https://0a3a00e9036cc0e380af0d0d00f3008f.web-security-academy.net/my-account/wcd.js"</script>

# 命中缓存后，攻击者访问相同的 url 即可获取敏感信息。
```

![image-20250507152953264](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/Web%20%E5%AE%89%E5%85%A8/Web%20%E7%BC%93%E5%AD%98%E6%AC%BA%E9%AA%97/images/image-20250507152953264.png)

务必测试多种常见静态资源扩展名，如：`.css`、`.ico`、`.exe`、`.js`、`.png`、`.jpg`、`.txt`等常见静态文件后缀。