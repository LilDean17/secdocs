### OAuth

OAuth（开放授权协议）是一种**开放标准的授权框架**，它允许用户在不共享账号密码的前提下，授予第三方应用或服务**有限的访问权限**，以访问用户在另一服务提供者（如Google、Facebook、GitHub等）的资源。

OAuth的核心是**授权**（Authorization），而非身份认证（Authentication）。它解决的是“如何让第三方应用在用户同意下访问特定资源”，而非“确认用户是谁”。

用户授权后，第三方应用会获得一个**访问令牌（Access Token）**，而非用户的密码。令牌具有以下特点：

- **权限范围可控**：令牌可限制访问的资源类型（如仅读取邮件，不可删除）。
- **有效期有限**：令牌可设置过期时间，降低长期风险。
- **可撤销**：用户可随时在授权方撤销令牌。

示例：

- 第三方应用：美团
- OAuth 提供方：微信

美团能通过微信登陆就是获取微信的授权，来获得某个用户的微信信息和功能。例如，美团使用微信登陆后，会以访问令牌访问用户个人信息（如：头像、id 等），但微信会限制美团使用访问令牌的访问范围（如：拒绝美团访问微信用户的密码和好友列表或聊天记录）。

```
注意
尽管 OAuth 2.0 是当前标准，但一些网站仍然使用旧版 1a。OAuth 2.0 是从头开始编写的，而不是直接从 OAuth 1.0 开发的。因此，两者截然不同。请注意，在这些材料中，术语“OAuth”仅指 OAuth 2.0。
```

### OAuth 核心角色

1. 客户端应用
   - 用于请求 OAuth 服务方用户资源的第三方应用（如美团）。
   - 职责：引导用户授权，获取访问令牌。
2. 资源所有者
   - 拥有数据所有权的用户（如：微信用户）。
   - 登录并同意授权。
3. OAuth 服务方
   - 管理用户数据和权限的服务（如微信）。
   - 授权：处理用户认证和授权（生成令牌）。
   - 资源：存储并提供用户资源（如用户数据、或微信支付）。

优点：令牌不暴露给前端，安全性高。

![image-20250513150704604](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/Web%20%E5%AE%89%E5%85%A8/OAuth%20%E6%8E%88%E6%9D%83%E6%BC%8F%E6%B4%9E/images/image-20250513150704604.png)

总结：

- 上图实线表示用户进行授权时，在浏览器页面跳转的顺序。
  - 第一步：用户从第三方应用的网站重定向到 OAuth 授权页面进行授权。
  - 第二步：用户在授权页面进行授权（点击确认授权按钮）。
  - 第三步：OAuth 授权页面发送一个重定向包给浏览器，重定向指向第三方应用的 callback 链接，用于触发第三方应用向服务器提交 code 以换取令牌的操作。
- 上图虚线表示第三方应用和 OAuth 服务方的通信。（用户无法抓到相关数据包）
  - 第四步：之前用户访问了第三方应用的 callback 链接，第三方应用使用获取到的 code 换取 token。
  - 第五步：OAuth 服务方返回 token 给应用。
  - 以后的步骤：第三方应用使用 token 访问 OAuth 服务方资源。

上述过程中，OAuth 服务方应该在第二步，用户完成授权操作后，将 code 和 token 以及重定向 url 和用户绑定在一起。

综上所述，完整的 OAuth 需要实现的接口如下：

- OAuth 服务方的认证接口：用于用户第三方的跳转到认证页面。

- 第三方的 callback 接口：访问此接口，用于触发服务端发送 code 换取 token 的操作。
- OAuth 服务方的 token 接口：用于第三方换取 token。

#### 隐式模式（Implicit Flow）

1. 用户授权后，微信直接将 Access Token 通过 URL 片段（Fragment）返回前端。
2. 前端 JavaScript 提取令牌并访问资源。

风险：令牌暴露在浏览器历史记录中，安全性较低（已逐渐被淘汰）。

![image-20250513152040830](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/Web%20%E5%AE%89%E5%85%A8/OAuth%20%E6%8E%88%E6%9D%83%E6%BC%8F%E6%B4%9E/images/image-20250513152040830.png)

注：

- 你会发现上图全是实线（通过浏览器完成）
  - 第一步：用户从第三方跳转到 OAuth 服务方。
  - 第二步：完成授权。
  - 第三步：OAuth 服务授权页面直接生成令牌和重定向的 callback 链接并嵌入 token。（抓包可以抓到的链接）
  - 第四步：第三方应用通过 js 代码使用 token 访问 OAuth 服务方资源。（token 被嵌入到用户数据包中）