### JWT（json web token）

JSON Web 令牌 （JWT） 是一种标准化格式，用于在系统之间发送加密签名的 JSON 数据。理论上，它们可以包含任何类型的数据，但最常见的用途是传递用户身份相关的**声明（claims）**，用于认证、会话管理和权限控制。

核心特点：

- 自包含性：所有必要信息（如用户身份、权限）直接存储在 JWT 中，无需服务器维护会话状态。
- 跨系统兼容：适用于分布式架构（如微服务、跨域单点登录），客户端可携带 JWT 与多个服务交互。
- 安全性：通过签名（JWS）或加密（JWE）保证数据完整性和机密性。

### JWT 的组成

一个 JWT 由三部分组成，用 `.` 分隔，格式：`Header.Payload.Signature`

1. Header（头部）：指定算法（如 HMAC、RSA）和令牌类型（固定为 `JWT`）。

```
json
{
  "alg": "HS256",  // 签名算法（如 HS256、RS256）
  "typ": "JWT"     // 固定为 "JWT"
}
```

2. Payload（载荷）：包含实际传输的数据（如用户 ID、权限）和标准声明（如过期时间）。

```
{
    "iss": "portswigger",
    "exp": 1648037164,
    "name": "Carlos Montoya",
    "sub": "carlos",
    "role": "blog_author",
    "email": "carlos@carlos-montoya.net",
    "iat": 1516239022
}
```

3. Signature（签名）：对前两部分的签名，用于验证数据完整性和来源真实性。

```
signature = HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret_key
)
```

- **验证过程**：服务器重新计算签名，与 JWT 中的签名比对。若不一致，则数据被篡改。

### JWT 的设计目的

1. 无状态认证：服务器无需存储会话信息（如传统 Session），所有必要数据直接嵌入令牌中，适合分布式系统或微服务架构。
2. 安全传输：通过签名（或加密，如 JWS/JWE）确保信息未被篡改，防止中间人攻击。
3. 跨域/跨系统兼容性：支持跨域身份验证（如单点登录），适合前后端分离或第三方 API 调用。

注：JWT 是由服务器颁发的，服务器不希望任何人修改自己颁发的 JWT（包括用户本身），用于用户身份的标识。

注：JWT 若被抓包抓到，很容易受重放攻击的影响，攻击者直接复制请求包里的 JWT 就能轻松伪装成指定用户。

### JWT vs JWS vs JWE

- JWT：抽象标准，定义 JSON 数据的传输格式，需依赖 JWS 或 JWE 实现。
- JWS（JSON Web Signature）：为 JWT 提供**签名机制**，确保数据完整性（最常用）。
- JWE（JSON Web Encryption）：为 JWT 提供**加密机制**，确保数据机密性。

```
JWT（容器）
├── JWS（签名令牌）：Header + Payload + Signature
└── JWE（加密令牌）：Header + Encrypted Payload + Signature
```

### **总结**

JWT 通过自包含、无状态的设计，成为分布式系统中身份验证的核心工具，但其安全性高度依赖签名机制和密钥管理。实际应用中需结合场景选择 JWS（签名）或 JWE（加密），并严格遵循安全最佳实践。

### JWT 攻击

JWT 攻击指攻击者篡改 JWT 以绕过身份验证，冒充合法用户。攻击得逞的核心原因是应用程序对 JWT 的处理存在缺陷，如：

1. **签名验证漏洞**：未正确验证签名，导致攻击者可篡改令牌内容。
2. **密钥泄露**：若签名密钥泄露或过弱，攻击者可伪造任意有效令牌。

此类漏洞可能导致严重后果，如权限提升或账户接管。JWT 规范的灵活性要求开发者谨慎实现安全机制，否则即使使用成熟库仍可能存在风险。

### JWT 非对称签名的生成和校验

一般采用 RSA 或 ECDSA 算法。

##### 生成非对称签名的步骤

1. **生成密钥对**：首先要生成一对公钥和私钥。私钥由服务器秘密保管，公钥可以公开。
2. **创建 JWT Payload**：JWT 负载包含了需要传输的信息，像用户 ID、角色等。
3. **选择签名算法**：采用非对称加密算法，例如 RSA 或 ECDSA。
4. **生成签名**：利用私钥对 JWT 的头部和负载进行签名。
5. **组合 JWT**：将头部、负载和签名用 `.` 连接起来，形成完整的 JWT。

##### 校验签名的步骤

1. **获取公钥**：客户端或者验证服务器需要获取到对应的公钥。
2. **解析 JWT**：把接收到的 JWT 解析成头部、负载和签名三部分。
3. **验证签名**：使用公钥对签名进行验证，确认 JWT 是否由持有私钥的服务器签发，并且内容未被篡改。

### JWT 对称签名的生成和校验

如 HS256（HMAC-SHA256）。

##### 生成 JWT 对称签名的步骤

1. **定义密钥**：选择一个用于签名的密钥，该密钥必须在服务端安全保存，同时客户端也需要知晓这个密钥以进行签名验证。
2. **创建 JWT 头部**：指定签名算法，例如 HS256。
3. **创建 JWT Payload**：包含要传递的用户信息，如用户 ID、角色等。
4. **生成签名**：使用指定的算法（如 HS256）和密钥对头部和负载进行签名。
5. **组合 JWT**：将头部、负载和签名用 `.` 连接起来，形成完整的 JWT。

##### 校验 JWT 弱签名的步骤

1. **获取密钥**：从安全存储中获取用于签名的密钥。
2. **解析 JWT**：将接收到的 JWT 拆分为头部、负载和签名三部分。
3. **验证签名**：使用相同的算法和密钥重新对头部和负载进行签名，将生成的签名与接收到的签名进行比较，如果一致则签名有效。
4. **验证负载内容**：根据业务需求，验证负载中的信息是否合法，如是否过期等。